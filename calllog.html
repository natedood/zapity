<!DOCTYPE html>
<html>
<head>
    <title>Call Log</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Include Bootstrap for layout and FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Include jQuery UI CSS for Tabs styling -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">

    <!-- Include jQuery and jQuery UI JS libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.bundle.min.js"></script>
    
    <style>
        /* Optional: reduce padding/margins to better integrate with your design */
        #tabs .ui-tabs-nav { margin: 0; padding: 0.5em; }
        #tabs .ui-tabs-panel { padding: 1em; }
    </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <a class="navbar-brand" href="#">Rimspec</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="callscreen.html">Call Screen</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="todos.html">Todo</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="calllog.html">Call Log</a>
        </li>
      </ul>
    </div>
  </nav>
  
<div style="margin-top: 70px;"></div>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <form id="dateFilterForm" class="form-inline">
        <label for="startDate" class="mr-2">Dates:</label>
        <div class="form-group mb-2">
          <input type="date" class="form-control" id="startDate" placeholder="mm/dd/yyyy">
        </div>
        <div class="form-group mx-sm-3 mb-2">
          <input type="date" class="form-control" id="endDate" placeholder="mm/dd/yyyy">
        </div>
      </form>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <form id="originFilterForm" class="form-inline">
        <label for="origin" class="mr-2">Origin:</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input origin-check" type="checkbox" name="origin" value="in" id="in" checked>
          <label class="form-check-label" for="in">In</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input origin-check" type="checkbox" name="origin" value="out" id="out" checked>
          <label class="form-check-label" for="out">Out</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input origin-check" type="checkbox" name="origin" value="walkin" id="walkin" checked>
          <label class="form-check-label" for="walkin">Walkin</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input origin-check" type="checkbox" name="origin" value="textin" id="textin" checked>
          <label class="form-check-label" for="textin">Textin</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input origin-check" type="checkbox" name="origin" value="textout" id="textout" checked>
          <label class="form-check-label" for="textout">Textout</label>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <form id="followUpFilterForm" class="form-inline">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="followuponly" id="followuponly" value="1">
          <label class="form-check-label" for="followuponly">Follow-up flagged only</label>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- New row for "Filter to phone numbers only" -->
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <form id="phoneFilterForm" class="form-inline">
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="filterByPhone" id="filterByPhone" value="1">
          <label class="form-check-label" for="filterByPhone">Filter to unique phone numbers only</label>
        </div>
      </form>
    </div>
  </div>
</div>

<br/>

<!-- Result count at the top -->
<div id="resultCountTop" class="container mb-2"></div>

<table class="table table-striped container">
  <thead>
    <tr>
      <th>Open</th>
      <th>Phone</th>
      <th>Name</th>
      <th>Date</th>
      <th>Origin</th>
      <th>Flags</th>
    </tr>
  </thead>
  <tbody>
    <!-- Template for call log items will be dynamically injected here -->
  </tbody>
</table>

<!-- Result count at the bottom -->
<div id="resultCountBottom" class="container mt-2"></div>

<script>
  // Function to load call log data based on the current filter form values.
  function loadCallLog() {
      // Get date filters.
      var startDate = $("#startDate").val();
      var endDate   = $("#endDate").val();
      
      // Get the origin filter as a comma-delimited string.
      var origins = [];
      $(".origin-check:checked").each(function(){
          origins.push($(this).val());
      });
      var originParam = origins.join(",");
      
      // Get the followuponly value (1 if checked, else 0).
      var followUpOnly = $("#followuponly").prop("checked") ? 1 : 0;
      
      console.log("Sending parameters:", {
          startDate: startDate,
          endDate: endDate,
          origin: originParam,
          followuponly: followUpOnly
      });
      
      $.ajax({
          url: "calllog.php",
          type: "GET",
          dataType: "json",
          data: {
              startDate: startDate,
              endDate: endDate,
              origin: originParam,
              followuponly: followUpOnly
              // Note: filterByPhone is handled client-side.
          },
          success: function(data) {
              console.log("Call log data:", data);
              
              // If "Filter to unique phone numbers only" is checked, consolidate the rows.
              if ($("#filterByPhone").prop("checked")) {
                  var uniqueCalls = {};
                  // Assuming the data is ordered descending by call_datetime,
                  // keep the first entry (most recent) for each phone number.
                  data.forEach(function(call) {
                      if (!uniqueCalls[call.phone_number]) {
                          uniqueCalls[call.phone_number] = call;
                      }
                  });
                  data = Object.values(uniqueCalls);
              }
              
              var tbody = $("table.table tbody");
              tbody.empty(); // Clear existing rows.
              
              // Update result count
              var totalResults = data.length;
              $("#resultCountTop").text("Total results: " + totalResults);
              $("#resultCountBottom").text("Total results: " + totalResults);
              
              data.forEach(function(call) {
                  var row = `<tr>
                      <td>
                        <button class="btn btn-success" onclick="openCallScreen('${call.phone_number}')">
                          <i class="fas fa-folder-open"></i>
                        </button>
                      </td>
                      <td>${String(call.phone_number).replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3')}</td>
                      <td>${ call.caller_id_name || ""}</td>
                      <td>${ new Date(call.call_datetime).toLocaleDateString()}</td>
                      <td>${call.call_origin}</td>
                      <td>${call.flags ? call.flags : ""}</td>
                  </tr>`;
                  tbody.append(row);
              });
          },
          error: function(xhr, status, error) {
              console.error("Error fetching call log:", error);
          }
      });
  }

  // On page load
  $(function(){
      // Set default dates to today.
      var today = new Date();
      today.setHours(today.getHours() - 6);
      var dt = today.toISOString().split('T')[0];
      $("#startDate").val(dt);
      $("#endDate").val(dt);
      
      // Bind change events on the filter form fields.
      $("#startDate, #endDate").on("change", loadCallLog);
      $(".origin-check").on("change", loadCallLog);
      $("#followuponly").on("change", loadCallLog);
      $("#filterByPhone").on("change", loadCallLog);
      
      // Load the call log on page load.
      loadCallLog();
  });

  // Function to open the call screen (modify as needed)
  function openCallScreen(phoneNumber) {
      window.location.href = "callscreen.html?number=" + phoneNumber;
  }
</script>
</body>
</html>